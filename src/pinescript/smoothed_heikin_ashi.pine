// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © smoothed-heikin-ashi contributors

//@version=5
indicator(
     "Smoothed Heiken Ashi",
     shorttitle = "Smoothed HA",
     overlay = true
 )

// =============================================================================
// INPUTS
// =============================================================================

firstSmoothingLength = input.int(
     10,
     "First Smoothing Length",
     minval = 1,
     maxval = 100,
     tooltip = "EMA period applied to OHLC before calculating Heiken Ashi"
 )

secondSmoothingLength = input.int(
     10,
     "Second Smoothing Length",
     minval = 1,
     maxval = 100,
     tooltip = "EMA period applied to Heiken Ashi candles for additional smoothing"
 )

bullishColor = input.color(
     color.new(color.lime, 0),
     "Bullish Color",
     inline = "colors"
 )

bearishColor = input.color(
     color.new(color.red, 0),
     "Bearish Color",
     inline = "colors"
 )

confirmationCandles = input.int(
     1,
     "Confirmation Candles",
     minval = 1,
     maxval = 10,
     tooltip = "Number of consecutive opposite-color candles required before trend change is confirmed. Higher values reduce false signals but increase lag."
 )

// =============================================================================
// FIRST SMOOTHING - Apply EMA to regular OHLC
// =============================================================================

smoothedOpen = ta.ema(open, firstSmoothingLength)
smoothedClose = ta.ema(close, firstSmoothingLength)
smoothedHigh = ta.ema(high, firstSmoothingLength)
smoothedLow = ta.ema(low, firstSmoothingLength)

// =============================================================================
// HEIKEN ASHI CALCULATION on smoothed values
// =============================================================================

// Heiken Ashi Close = average of OHLC
heikenAshiClose = (smoothedOpen + smoothedHigh + smoothedLow + smoothedClose) / 4

// Heiken Ashi Open = average of previous HA open and close
var float heikenAshiOpen = na
heikenAshiOpen := na(heikenAshiOpen[1])
     ? (smoothedOpen + smoothedClose) / 2
     : (heikenAshiOpen[1] + heikenAshiClose[1]) / 2

// Heiken Ashi High = maximum of high, HA open, and HA close
heikenAshiHigh = math.max(smoothedHigh, math.max(heikenAshiOpen, heikenAshiClose))

// Heiken Ashi Low = minimum of low, HA open, and HA close
heikenAshiLow = math.min(smoothedLow, math.min(heikenAshiOpen, heikenAshiClose))

// =============================================================================
// SECOND SMOOTHING - Apply EMA to Heiken Ashi candles
// =============================================================================

finalOpen = ta.ema(heikenAshiOpen, secondSmoothingLength)
finalClose = ta.ema(heikenAshiClose, secondSmoothingLength)
finalHigh = ta.ema(heikenAshiHigh, secondSmoothingLength)
finalLow = ta.ema(heikenAshiLow, secondSmoothingLength)

// =============================================================================
// CONFIRMATION LOGIC - Require N consecutive candles before trend change
// =============================================================================

// Determine raw direction from candle
bool rawIsBullish = finalClose > finalOpen
bool rawIsBearish = finalClose < finalOpen

// Track consecutive candle counts
var int consecutiveBullish = 0
var int consecutiveBearish = 0
var bool confirmedTrend = true  // true = bullish, false = bearish

// Count consecutive candles in each direction
if rawIsBullish
    consecutiveBullish += 1
    consecutiveBearish := 0
else if rawIsBearish
    consecutiveBearish += 1
    consecutiveBullish := 0

// Change confirmed trend only when threshold is reached
if consecutiveBullish >= confirmationCandles
    confirmedTrend := true
else if consecutiveBearish >= confirmationCandles
    confirmedTrend := false

// =============================================================================
// VISUALIZATION
// =============================================================================

// Determine candle color based on confirmed trend
candleColor = confirmedTrend ? bullishColor : bearishColor

// Plot the smoothed Heiken Ashi candles
plotcandle(
     finalOpen,
     finalHigh,
     finalLow,
     finalClose,
     title = "Smoothed Heiken Ashi",
     color = candleColor,
     wickcolor = candleColor,
     bordercolor = candleColor
 )

// =============================================================================
// TREND INFORMATION (optional - for debugging or additional analysis)
// =============================================================================

// Export confirmed trend state for use in other indicators or strategies
bool isBullish = confirmedTrend
bool isBearish = not confirmedTrend

// Plot trend background (very subtle) based on CONFIRMED trend
bgcolor(
     confirmedTrend ? color.new(bullishColor, 97) : color.new(bearishColor, 97),
     title = "Trend Background"
 )

// Detect when confirmation just completed (counter just reached threshold)
bool bullishJustConfirmed = consecutiveBullish == confirmationCandles and consecutiveBullish[1] == confirmationCandles - 1
bool bearishJustConfirmed = consecutiveBearish == confirmationCandles and consecutiveBearish[1] == confirmationCandles - 1

// Plot markers when confirmation threshold is reached
plotshape(
     bullishJustConfirmed,
     title = "Bullish Confirmation",
     style = shape.triangleup,
     location = location.belowbar,
     color = bullishColor,
     size = size.small
 )

plotshape(
     bearishJustConfirmed,
     title = "Bearish Confirmation",
     style = shape.triangledown,
     location = location.abovebar,
     color = bearishColor,
     size = size.small
 )
